<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>GT-–ë–æ—Ç ¬∑ –î–∞—à–±–æ—Ä–¥</title>

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="GT-–ë–æ—Ç">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <style>
    :root{
      --bg:#0f0f12; --card:#171a21; --muted:#8a8f98; --text:#e9edf1;
      --green:#00c087; --red:#f6465d; --border:#2a2f3a; --yellow:#f0b90b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial;
      background:var(--bg); color:var(--text);
      padding-bottom: env(safe-area-inset-bottom);
    }
    header{
      position:sticky; top:0; z-index:10;
      background:#1a1f28;
      padding:6px; padding-top:calc(6px + env(safe-area-inset-top));
      font-size:11px; border-bottom:1px solid var(--border);
    }
    .wrap{display:flex; gap:6px; align-items:center; flex-wrap:wrap}
    h1{font-size:14px; margin:0; color:var(--yellow);}
    .pill{
      padding:1px 6px; border-radius:10px; font-size:10px;
      font-weight:600; min-width:55px; text-align:center;
    }
    .pill.online{background:#193e2d; color:var(--green);}
    .pill.offline{background:#3e1919; color:var(--red);}
    .pill.secondary{background:#242a33; color:#c8ccd3; border:1px solid var(--border)}
    main{padding:6px; display:grid; gap:8px}
    .card{background:var(--card); border:1px solid var(--border); border-radius:8px; overflow:hidden}
    .card h2{margin:0; padding:6px; font-size:12px; border-bottom:1px solid var(--border); color:var(--yellow)}
    .grid{overflow-x:hidden}
    table{width:100%; border-collapse:collapse; font-size:7.5px; table-layout:fixed}
    th,td{padding:3px 2px; border-bottom:1px solid var(--border); text-align:center; white-space:nowrap}
    th{background:#1a1f28; color:#c8ccd3; font-size:8px; position:sticky; top:0}
    .buy{color:var(--green); font-weight:600}
    .sell{color:var(--red); font-weight:600}
    .pos{color:var(--green); font-weight:600}
    .neg{color:var(--red); font-weight:600}
    .muted{color:var(--muted)}
    footer{padding:4px; font-size:9px; color:var(--muted); text-align:center}

    /* üîí –õ–û–ö-–≠–ö–†–ê–ù */
    .lock{
      position:fixed; inset:0; z-index:9999;
      display:flex; align-items:center; justify-content:center;
      background:rgba(10,10,12,.92);
      backdrop-filter: blur(8px);
    }
    .lock .panel{
      width:min(92vw, 360px);
      background:#171a21; border:1px solid var(--border); border-radius:12px;
      padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.3);
    }
    .lock h3{margin:0 0 10px; font-size:16px; color:var(--yellow);}
    .lock label{display:block; font-size:12px; color:#c8ccd3; margin-bottom:6px}
    .lock input{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border);
      background:#121418; color:var(--text); font-size:14px; outline:none;
    }
    .lock button{
      margin-top:10px; width:100%; padding:10px 12px; border:0; border-radius:10px;
      background:var(--yellow); color:#1a1f28; font-weight:700; cursor:pointer;
    }
    .lock .err{margin-top:8px; color:var(--red); font-size:12px; min-height:1em}
    .hidden{display:none !important;}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>GT-–ë–æ—Ç</h1>
      <span id="status" class="pill">‚Äî</span>
      <span id="pfFree" class="pill">USDT: ‚Äî</span>
      <span id="pfTotal" class="pill">‚àë: ‚Äî</span>
      <span id="updated" class="pill">‚Äî</span>
      <button id="logoutBtn" class="pill secondary">–í—ã–π—Ç–∏</button>
    </div>
  </header>

  <main id="app">
    <section class="card">
      <h2>üìä –ü–æ—Ä—Ç—Ñ–µ–ª—å</h2>
      <div class="grid"><table id="portfolio"></table></div>
    </section>

    <section class="card">
      <h2>üìë –û—Ç–∫—Ä—ã—Ç—ã–µ –æ—Ä–¥–µ—Ä–∞ (<b id="ooCount">‚Äî</b>)</h2>
      <div class="grid"><table id="orders"></table></div>
    </section>
  </main>

  <footer>üì± –î–æ–±–∞–≤—å –Ω–∞ iPhone: –ü–æ–¥–µ–ª–∏—Ç—å—Å—è ‚Üí ¬´–ù–∞ —ç–∫—Ä–∞–Ω –î–æ–º–æ–π¬ª</footer>

  <!-- üîí –û–≤–µ—Ä–ª–µ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
  <div id="lock" class="lock hidden">
    <div class="panel">
      <h3>–î–æ—Å—Ç—É–ø –∫ –¥–∞—à–±–æ—Ä–¥—É</h3>
      <label for="pwd">–ü–∞—Ä–æ–ª—å</label>
      <input id="pwd" type="password" autocomplete="current-password" inputmode="latin-prose" />
      <button id="loginBtn">–í–æ–π—Ç–∏</button>
      <div id="err" class="err"></div>
    </div>
  </div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxfMjbnI3FJXB5A29d0okRRelF4-I-4tEBddCWAbWUPJhSJRAEvpbC8DFOsv4Bxbs_m9A/exec";

/* ====== –ü–ê–†–û–õ–¨ (–ü–û–ú–ï–ù–Ø–ô) ====== */
const PASS = "GT777";                 // ‚Üê –∑–∞–¥–∞–π —Å–≤–æ–π –ø–∞—Ä–æ–ª—å
const AUTH_KEY = "gtbot_auth_v2";     // –Ω–æ–≤—ã–π –∫–ª—é—á, —á—Ç–æ–±—ã –∑–∞–Ω–æ–≤–æ —Å–ø—Ä–æ—Å–∏–ª–æ –ø–∞—Ä–æ–ª—å
let refreshTimer = null;

/* ====== –£–¢–ò–õ–´ ====== */
const $ = sel => document.querySelector(sel);
function setStatusOnline(){
  const s = $('#status');
  s.textContent = "–û–Ω–ª–∞–π–Ω"; s.className = "pill online";
}
function setStatusOffline(){
  const s = $('#status');
  s.textContent = "–û—Ñ—Ñ–ª–∞–π–Ω"; s.className = "pill offline";
}
function clsPnL(v){
  // –∫—Ä–∞—Å–∏–º –ª—é–±–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–≤–∫–ª—é—á–∞—è 0) ‚Äî 0 –±—É–¥–µ—Ç –∑–µ–ª—ë–Ω—ã–º –∫–∞–∫ "–Ω–µ –º–∏–Ω—É—Å"
  const x = parseFloat(String(v).replace('%','').replace(',','.'));
  if (!isFinite(x)) return '';
  return x >= 0 ? 'pos' : 'neg';
}

/* ====== –†–ï–ù–î–ï–† –¢–ê–ë–õ–ò–¶ ====== */
function renderTable(id, rows){
  const table = document.getElementById(id);
  table.innerHTML = "";
  if (!rows || !rows.length){
    table.innerHTML = "<tr><td class='muted'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>";
    return;
  }

  rows.forEach((row, i)=>{
    let filteredRow = row;

    if (id === 'orders'){
      // –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ: –°–∏–º–≤–æ–ª, –°—Ç–æ—Ä–æ–Ω–∞, –¢–∏–ø –æ—Ä–¥–µ—Ä–∞, –¶–µ–Ω–∞, –ö–æ–ª-–≤–æ, –û—Å—Ç–∞—Ç–æ–∫
      // –∏–Ω–¥–µ–∫—Å—ã –∏—Å—Ö–æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã: [2,3,4,6,8,9]
      filteredRow = [row[2], row[3], row[4], row[6], row[8], row[9]];
    }

    if (id === 'portfolio'){
      // —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 7 –∫–æ–ª–æ–Ω–æ–∫
      filteredRow = row.slice(0,7);
    }

    const tr = document.createElement("tr");
    filteredRow.forEach((cell, j)=>{
      const tag = i===0 ? "th" : "td";
      const td  = document.createElement(tag);
      const val = String(cell).trim();

      // üî¥ –í –û–†–î–ï–†–ê–• –∫—Ä–∞—Å–∏–º –¢–û–õ–¨–ö–û –∫–æ–ª–æ–Ω–∫—É SIDE (–∏–Ω–¥–µ–∫—Å 1 –≤ filteredRow)
      if (id==='orders' && i>0 && j===1){
        if (val==="BUY")  td.className="buy";
        if (val==="SELL") td.className="sell";
      }

      // üü¢ –í –ü–û–†–¢–§–ï–õ–ï –∫—Ä–∞—Å–∏–º PnL % –∏ PnL $ (–∏–Ω–¥–µ–∫—Å—ã 5 –∏ 6 –≤ filteredRow)
      if (id==='portfolio' && i>0 && (j===5 || j===6)){
        td.className = clsPnL(val);
      }

      td.textContent = val;
      tr.appendChild(td);
    });
    table.appendChild(tr);
  });
}

/* ====== –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ====== */
async function loadData(){
  try{
    $('#status').textContent="–û–±–Ω–æ–≤–ª—è—é‚Ä¶";
    $('#status').className="pill";

    const res = await fetch(API_URL, { cache:"no-store" });
    if (!res.ok) throw new Error("HTTP "+res.status);
    const data = await res.json();

    renderTable("portfolio", data.portfolio);
    renderTable("orders", data.openOrders);

    // —Å—á—ë—Ç—á–∏–∫ –æ—Ä–¥–µ—Ä–æ–≤
    $('#ooCount').textContent = Math.max(0, (data.openOrders?.length||1)-1);

    // —Å–≤–æ–¥–∫–∞ –¥–ª—è —à–∞–ø–∫–∏
    let free = "‚Äî", total="‚Äî";
    try{
      const scan = data.portfolio.slice(0,3);
      for (const r of scan){
        for (let i=0;i<r.length-1;i++){
          const k = String(r[i]||'').toLowerCase();
          if (k.includes('—Å–≤–æ–±–æ–¥–Ω—ã–µ usdt')) free = r[i+1];
          if (k.includes('–æ–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ—Ä—Ç—Ñ–µ–ª—è')) total = r[i+1];
        }
      }
    }catch(_){}
    $('#pfFree').textContent  = "USDT: "+free;
    $('#pfTotal').textContent = "‚àë: "+total;

    $('#updated').textContent = new Date().toLocaleString('ru-RU');

    setStatusOnline();
  }catch(e){
    setStatusOffline();
  }
}

/* ====== –ê–í–¢–û-–û–ë–ù–û–í–õ–ï–ù–ò–ï ====== */
function startAuto(){
  if (refreshTimer) clearInterval(refreshTimer);
  refreshTimer = setInterval(loadData, 60000);
}

/* ====== –õ–û–ì–ò–ù/–õ–û–ì–ê–£–¢ ====== */
function isAuthed(){ return localStorage.getItem(AUTH_KEY) === '1'; }
function showLock(){ $('#lock').classList.remove('hidden'); }
function hideLock(){ $('#lock').classList.add('hidden'); }
function tryLogin(){
  const v = $('#pwd').value.trim();
  if (v === PASS){
    localStorage.setItem(AUTH_KEY, '1');
    $('#err').textContent = "";
    hideLock();
    loadData();
    startAuto();
  } else {
    $('#err').textContent = "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å";
  }
}

document.addEventListener('DOMContentLoaded', ()=>{
  // –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ª–æ–≥–∏–Ω–∞/–ª–æ–≥–∞—É—Ç–∞
  $('#loginBtn').addEventListener('click', tryLogin);
  $('#pwd').addEventListener('keydown', (e)=>{ if (e.key === 'Enter') tryLogin(); });
  $('#logoutBtn').addEventListener('click', ()=>{
    localStorage.removeItem(AUTH_KEY);
    location.reload();
  });

  // –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫
  if (isAuthed()){
    hideLock();
    loadData();
    startAuto();
  } else {
    setStatusOffline();
    showLock();
    setTimeout(()=>$('#pwd').focus(), 50);
  }
});
</script>
</body>
</html>