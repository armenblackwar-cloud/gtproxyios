<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=yes" />
  <title>GT-–ë–æ—Ç ¬∑ –î–∞—à–±–æ—Ä–¥</title>

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="GT-–ë–æ—Ç">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

 <style>
  :root{
    --bg:#0f0f12; --card:#171a21; --muted:#8a8f98; --text:#e9edf1;
    --green:#00c087; --red:#f6465d; --border:#2a2f3a; --yellow:#f0b90b;
  }
  body{margin:0; font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial;
       background:var(--bg); color:var(--text);}
  header{position:sticky; top:0; background:#10141b; padding:4px; font-size:10px; border-bottom:1px solid var(--border)}
  .wrap{display:flex; flex-wrap:wrap; gap:6px; align-items:center}
  h1{font-size:12px; margin:0; color:var(--yellow);}
  .pill{padding:1px 4px; border:1px solid var(--border); border-radius:4px; font-size:9px; color:var(--muted)}
  main{padding:4px; display:grid; gap:6px}
  .card{background:var(--card); border:1px solid var(--border); border-radius:8px; overflow:hidden}
  .card h2{margin:0; padding:4px; font-size:11px; border-bottom:1px solid var(--border); color:var(--yellow)}
  .grid{overflow-x:hidden}
  /* —Ç–∞–±–ª–∏—Ü—ã –µ—â—ë –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ */
  table{width:100%; border-collapse:collapse; font-size:7.5px; table-layout:fixed}
  th,td{padding:2px 1px; border-bottom:1px solid var(--border); text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  th{background:#1a1f28; color:#c8ccd3; font-size:8px; position:sticky; top:0}
  td{font-size:7.5px}
  .buy{color:var(--green); font-weight:600}
  .sell{color:var(--red); font-weight:600}
  .pos{color:var(--green); font-weight:600}
  .neg{color:var(--red); font-weight:600}
  .muted{color:var(--muted)}
  footer{padding:4px; font-size:8px; color:var(--muted); text-align:center}
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>GT-–ë–æ—Ç</h1>
      <span id="status"  class="pill">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</span>
      <span id="pfFree"  class="pill">USDT: ‚Äî</span>
      <span id="pfTotal" class="pill">Œ£: ‚Äî</span>
      <span id="updated" class="pill">‚Äî</span>
    </div>
  </header>

  <main>
    <section class="card">
      <h2>üìä –ü–æ—Ä—Ç—Ñ–µ–ª—å</h2>
      <div class="grid"><table id="portfolio"></table></div>
    </section>

    <section class="card">
      <h2>üìë –û—Ç–∫—Ä—ã—Ç—ã–µ –æ—Ä–¥–µ—Ä–∞ (<b id="ooCount">‚Äî</b>)</h2>
      <div class="grid"><table id="orders"></table></div>
    </section>
  </main>

  <footer>üì± –î–æ–±–∞–≤—å –Ω–∞ iPhone: –ü–æ–¥–µ–ª–∏—Ç—å—Å—è ‚Üí ¬´–ù–∞ —ç–∫—Ä–∞–Ω –î–æ–º–æ–π¬ª</footer>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxfMjbnI3FJXB5A29d0okRRelF4-I-4tEBddCWAbWUPJhSJRAEvpbC8DFOsv4Bxbs_m9A/exec";

/* –∫–∞–∫–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å */
const KEEP = {
  // –ü–æ—Ä—Ç—Ñ–µ–ª—å: –±–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 7 —Å—Ç–æ–ª–±—Ü–æ–≤ (A..G)
  portfolio: [0,1,2,3,4,5,6],
  // –û—Ä–¥–µ—Ä–∞: –æ—Å—Ç–∞–≤–ª—è–µ–º –ú–æ–Ω–µ—Ç–∞(2), –°—Ç–æ—Ä–æ–Ω–∞(3), –¢–∏–ø(4), –¶–µ–Ω–∞(6), –ö–æ–ª-–≤–æ(8), –û—Å—Ç–∞—Ç–æ–∫(9)
  orders:    [2,3,4,6,8,9]
};

function clsPnL(v){
  const x = parseFloat(v);
  if (isNaN(x) || x===0) return 'muted';
  return x>0 ? 'pos' : 'neg';
}

function renderTable(id, rows){
  const table = document.getElementById(id);
  table.innerHTML = "";
  if (!rows || !rows.length){
    table.innerHTML = "<tr><td class='muted'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>";
    return;
  }

  const keepIdx = KEEP[id];

  rows.forEach((row, i)=>{
    // –∏–∑ –ø–æ—Ä—Ç—Ñ–µ–ª—è –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
    if (id==='portfolio' && i>0){
      const txt = row.join(" ").toLowerCase();
      if (txt.includes("—Å–≤–æ–±–æ–¥–Ω—ã–µ usdt") || txt.includes("–æ–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å") || txt.includes("–æ–±–Ω–æ–≤–ª–µ–Ω–æ")) return;
    }

    const tr = document.createElement("tr");

    keepIdx.forEach((origJ, newJ)=>{
      const tag = i===0 ? "th" : "td";
      const td  = document.createElement(tag);
      const val = row[origJ] ?? "";

      // –ü–æ–¥—Å–≤–µ—Ç–∫–∏
      if (id==='orders' && i>0 && newJ===1){           // –°—Ç–æ—Ä–æ–Ω–∞ –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞ ‚Äî –∏–Ω–¥–µ–∫—Å 1
        const side = String(val).trim().toUpperCase();
        td.className = side==="BUY" ? "buy" : side==="SELL" ? "sell" : "";
      }
      if (id==='portfolio' && i>0 && (newJ===5 || newJ===6)){ // PnL % –∏ $ ‚Äî –∏–Ω–¥–µ–∫—Å—ã 5 –∏ 6 –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞
        td.className = clsPnL(val);
      }

      td.textContent = String(val).trim();
      tr.appendChild(td);
    });

    table.appendChild(tr);
  });
}

function extractTopBadges(portfolio){
  try{
    const scan = portfolio.slice(0,5);
    let free=null, total=null, upd=null;
    for (const r of scan){
      for (let i=0;i<r.length-1;i++){
        const k = String(r[i]||'').toLowerCase();
        if (k.includes('—Å–≤–æ–±–æ–¥–Ω—ã–µ usdt')) free  = r[i+1];
        if (k.includes('–æ–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å')) total = r[i+1];
        if (k.includes('–æ–±–Ω–æ–≤–ª–µ–Ω–æ'))       upd   = r[i+1];
      }
    }
    if (free  != null) document.getElementById('pfFree').textContent  = "USDT: " + free;
    if (total != null) document.getElementById('pfTotal').textContent = "Œ£: " + total;
    if (upd   != null) document.getElementById('updated').textContent = upd;
  }catch(_){}
}

async function loadData(){
  try{
    document.getElementById('status').textContent="–û–±–Ω–æ–≤–ª—è—é‚Ä¶";
    const res = await fetch(API_URL, {cache:"no-store"});
    const data = await res.json();

    const portfolio = Array.isArray(data.portfolio)  ? data.portfolio  : [];
    const orders    = Array.isArray(data.openOrders) ? data.openOrders : [];

    renderTable("portfolio", portfolio);
    renderTable("orders", orders);

    document.getElementById('ooCount').textContent = Math.max(0, orders.length-1);
    extractTopBadges(portfolio);

    document.getElementById('status').textContent="–û–Ω–ª–∞–π–Ω";
  }catch(e){
    document.getElementById('status').textContent="–û—à–∏–±–∫–∞";
  }
}

loadData();
setInterval(loadData, 60000);
</script>
</body>
</html>
