<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>GT ¬∑ Dashboard</title>
  <style>
    :root{
      --bg:#0f0f12; --card:#171a21; --muted:#8a8f98; --text:#e9edf1;
      --green:#00c087; --red:#f6465d; --border:#2a2f3a; --yellow:#f0b90b;
    }
    body{margin:0; font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial;
      background:var(--bg); color:var(--text); padding-top: env(safe-area-inset-top);}
    header{position:sticky; top:0; background:#1a1f28; padding:6px; font-size:11px; display:flex; flex-direction:column; gap:4px}
    h1{font-size:14px; margin:0; color:var(--yellow);}
    .pill{padding:2px 14px; border-radius:20px; font-size:11px; font-weight:600; text-align:center; display:inline-block; min-width:90px;}
    .pill.online{background:#193e2d; color:var(--green);}
    .pill.offline{background:#3e1919; color:var(--red);}
    .pill.pos{background:#193e2d; color:var(--green);}
    .pill.neg{background:#3e1919; color:var(--red);}
    .pill.muted{background:#333; color:var(--muted);}
    .logout{background:#333; cursor:pointer; padding:6px 10px; margin:10px 5px; display:inline-block; border-radius:8px; font-size:12px;}
    .header-top, .header-bottom{display:flex; gap:6px; align-items:center; flex-wrap:wrap}
    .header-bottom{width:100%; justify-content:space-between; margin-top:2px;}
    .header-bottom .pill{margin-right:8px;}
    main{padding:6px; display:grid; gap:8px}
    .card{background:var(--card); border:1px solid var(--border); border-radius:8px; overflow:hidden}
    .card h2{margin:0; padding:6px; font-size:12px; border-bottom:1px solid var(--border); color:var(--yellow)}
    .grid{overflow-x:hidden}
    table{width:100%; border-collapse:collapse; font-size:8px; table-layout:auto}
    th,td{padding:3px 2px;border:1px solid var(--border);text-align:center;white-space:normal;word-wrap:break-word;max-width:80px;}
    th{background:#1a1f28; color:#c8ccd3; font-size:8px; position:sticky; top:0}
    .buy{color:var(--green); font-weight:600}
    .sell{color:var(--red); font-weight:600}
    .pos{color:var(--green); font-weight:600}
    .neg{color:var(--red); font-weight:600}
    .muted{color:var(--muted)}
    .sectionRow{text-align:center; font-weight:700; color:var(--yellow); background:#222; padding:4px;}
    footer{padding:4px; font-size:9px; color:var(--muted); text-align:center}
    #startScreen{display:flex; flex-direction:column; justify-content:center; align-items:center; height:100vh; gap:20px}
    .startBtn{background:var(--yellow); color:#000; font-weight:700; border:none; border-radius:8px; padding:15px 25px; font-size:16px; cursor:pointer}
    .btnRow{text-align:center; margin:10px 0;}
    @media (max-width:700px){
      .header-bottom{flex-direction:column; align-items:flex-start;}
      .header-bottom .pill{margin:2px 0;}
    }
  </style>
</head>
<body>

<div id="startScreen">
  <h1>üöÄ GT</h1>
  <button class="startBtn" onclick="chooseMode('kripto')">GT-CRYPTO</button>
  <button class="startBtn" onclick="chooseMode('invest')">GT-INVEST</button>
</div>

<div id="app" style="display:none">
  <header>
    <div class="header-top">
      <h1 id="modePill">‚Äî</h1>
      <span id="status" class="pill">‚Äî</span>
      <span id="updated" class="pill muted">‚Äî</span>
      <button id="switchBtn" class="pill">üîÑ –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å</button>
    </div>
    <div class="header-bottom">
      <span id="pfFree" class="pill muted">–°–≤–æ–±–æ–¥–Ω—ã–µ: ‚Äî</span>
      <span id="pfPnlPct" class="pill muted">PNL %: ‚Äî</span>
      <span id="pfPnlRub" class="pill muted">PNL ‚ÇΩ/$: ‚Äî</span>
      <span id="pfTotal" class="pill muted">–û–±—ä–µ–º: ‚Äî</span>
    </div>
  </header>

  <main>
    <section class="card">
      <h2>üìä –ü–æ—Ä—Ç—Ñ–µ–ª—å</h2>
      <div class="grid"><table id="portfolio"></table></div>
    </section>

    <section class="card">
      <h2>üìë –û—Ç–∫—Ä—ã—Ç—ã–µ –æ—Ä–¥–µ—Ä–∞ (<b id="ooCount">‚Äî</b>)</h2>
      <div class="grid"><table id="orders"></table></div>
    </section>
  </main>

  <footer>
    üì± –î–æ–±–∞–≤—å –Ω–∞ iPhone: –ü–æ–¥–µ–ª–∏—Ç—å—Å—è ‚Üí ¬´–ù–∞ —ç–∫—Ä–∞–Ω –î–æ–º–æ–π¬ª
  </footer>

  <div class="btnRow">
    <button id="logoutBtn" class="logout">üö™ –í—ã–π—Ç–∏</button>
    <button id="copyBtn" class="logout">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
  </div>
</div>

<script>
// ====== –ü–∞—Ä–æ–ª—å ======
const PASSWORD = "Gt4815162342!";
const STORAGE_KEY = "gtbot_auth";

// –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã—Ö–æ–¥ –ø–æ URL-–ø–∞—Ä–∞–º–µ—Ç—Ä—É ?logout=1
if (location.search.includes("logout=1")) {
  localStorage.removeItem(STORAGE_KEY);
  localStorage.removeItem("gtbot_mode");
  location.replace(location.origin + location.pathname);
}

function isAuthed(){ return localStorage.getItem(STORAGE_KEY) === "ok"; }

function ensureAuth() {
  if (isAuthed()) return true;
  const input = prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞:");
  if (input === PASSWORD) {
    localStorage.setItem(STORAGE_KEY, "ok");
    return true;
  }
  alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
  return false;
}

// ====== API ======
const API_URLS = {
  kripto: "https://script.google.com/macros/s/AKfycbxfMjbnI3FJXB5A29d0okRRelF4-I-4tEBddCWAbWUPJhSJRAEvpbC8DFOsv4Bxbs_m9A/exec",
  invest: "https://script.google.com/macros/s/AKfycbwTsu4LskXHYxx7x9QpA9u-eACTZsPWvjrvDF72nE0oScpAA7lf5a39ZDZWRTC2V8APpw/exec"
};

let currentMode = localStorage.getItem("gtbot_mode") || null;

function chooseMode(mode){
  if (!ensureAuth()) return;
  currentMode = mode;
  localStorage.setItem("gtbot_mode", mode);
  document.getElementById("startScreen").style.display="none";
  document.getElementById("app").style.display="block";
  updateModePill();
  loadData();
}

function updateModePill(){
  document.getElementById("modePill").textContent =
    currentMode==="kripto" ? "GT-CRYPTO" : "GT-INVEST";
}

// ===== Helpers =====
function clsPnL(v){
  const s = String(v).replace(/\s/g,'');
  if (s === "" || s === "0" || s === "0,00" || s === "0.00" || s === "0%") return 'muted';
  if (parseFloat(s.replace(',','.')) < 0) return 'neg';
  return 'pos';
}

// –§–æ—Ä–º–∞—Ç RUB (–∏–Ω–≤–µ—Å—Ç) –∏ –≤—Å–µ —Å—É–º–º—ã —Å –ø—Ä–æ–±–µ–ª–æ–º-—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–º
function fmtRub(val) {
  const num = parseFloat(val);
  if (isNaN(num)) return val;
  return num.toLocaleString('ru-RU', {minimumFractionDigits:2, maximumFractionDigits:2});
}

// –§–æ—Ä–º–∞—Ç –¥–ª—è –ª—é–±—ã—Ö —á–∏—Å–µ–ª (—Ü–µ–Ω–∞, –æ–±—ä—ë–º, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ)
function fmtNum(val) {
  const num = parseFloat(val);
  if (isNaN(num)) return val;
  return num.toLocaleString('ru-RU', {minimumFractionDigits:2, maximumFractionDigits:2});
}

// –§–æ—Ä–º–∞—Ç PNL % ‚Äî —É–º–Ω–æ–∂–∞–µ–º –Ω–∞ 100 –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∑–Ω–∞–∫ %
function fmtInvestPct(val) {
  const num
