<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>GT-–ë–æ—Ç ¬∑ –î–∞—à–±–æ—Ä–¥</title>

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="GT-–ë–æ—Ç">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <style>
    :root{
      --bg:#0f0f12; --card:#171a21; --muted:#8a8f98; --text:#e9edf1;
      --green:#00c087; --red:#f6465d; --border:#2a2f3a; --yellow:#f0b90b;
    }
    body{margin:0; font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial;
         background:var(--bg); color:var(--text);}
    header{
      position:sticky; top:0; background:#161a22; 
      padding:6px; font-size:10px; border-bottom:1px solid var(--border);
      box-shadow:0 1px 2px rgba(0,0,0,0.4); /* –ª—ë–≥–∫–∞—è —Ç–µ–Ω—å */
    }
    .wrap{display:flex; flex-wrap:wrap; gap:6px; align-items:center}
    h1{font-size:13px; margin:0; color:var(--yellow); font-weight:700;}
    .pill{
      padding:2px 6px; border:1px solid var(--border); border-radius:6px;
      font-size:9px; color:var(--muted); background:#1e222d;
    }
    main{padding:6px; display:grid; gap:8px}
    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:10px; overflow:hidden
    }
    .card h2{
      margin:0; padding:6px; font-size:12px;
      border-bottom:1px solid var(--border); color:var(--yellow)
    }
    .grid{overflow-x:hidden}
    table{
      width:100%; border-collapse:collapse; font-size:7px; table-layout:fixed
    }
    th,td{
      padding:2px 1px; border-bottom:1px solid var(--border);
      text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis
    }
    th{background:#1a1f28; color:#c8ccd3; font-size:8px; position:sticky; top:0}
    td{font-size:7px}
    .buy{color:var(--green); font-weight:600}
    .sell{color:var(--red); font-weight:600}
    .pos{color:var(--green); font-weight:600}
    .neg{color:var(--red); font-weight:600}
    .muted{color:var(--muted)}
    footer{padding:4px; font-size:8px; color:var(--muted); text-align:center}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>GT-–ë–æ—Ç</h1>
      <span id="status" class="pill">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</span>
      <span id="pfFree" class="pill">USDT: ‚Äî</span>
      <span id="pfTotal" class="pill">Œ£: ‚Äî</span>
      <span id="updated" class="pill">‚Äî</span>
    </div>
  </header>

  <main>
    <section class="card">
      <h2>üìä –ü–æ—Ä—Ç—Ñ–µ–ª—å</h2>
      <div class="grid"><table id="portfolio"></table></div>
    </section>

    <section class="card">
      <h2>üìë –û—Ç–∫—Ä—ã—Ç—ã–µ –æ—Ä–¥–µ—Ä–∞ (<b id="ooCount">‚Äî</b>)</h2>
      <div class="grid"><table id="orders"></table></div>
    </section>
  </main>

  <footer>üì± –î–æ–±–∞–≤—å –Ω–∞ iPhone: –ü–æ–¥–µ–ª–∏—Ç—å—Å—è ‚Üí ¬´–ù–∞ —ç–∫—Ä–∞–Ω –î–æ–º–æ–π¬ª</footer>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxfMjbnI3FJXB5A29d0okRRelF4-I-4tEBddCWAbWUPJhSJRAEvpbC8DFOsv4Bxbs_m9A/exec";

function clsPnL(v){
  const x = parseFloat(v);
  if (isNaN(x) || x===0) return 'muted';
  return x>0 ? 'pos' : 'neg';
}

function renderTable(id, rows){
  const table = document.getElementById(id);
  table.innerHTML = "";
  if (!rows || !rows.length){
    table.innerHTML = "<tr><td class='muted'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>";
    return;
  }
  rows.forEach((row, i)=>{
    const tr = document.createElement("tr");
    row.forEach((cell, j)=>{
      // —É–±–∏—Ä–∞–µ–º –Ω–µ–Ω—É–∂–Ω—ã–µ —Å—Ç–æ–ª–±—Ü—ã
      if (id==='orders'){
        if (j===0 || j===1 || j===5) return; // ‚ùå –í—Ä–µ–º—è, –ö–∞—Ç–µ–≥–æ—Ä–∏—è, –°—Ç–∞—Ç—É—Å
      }
      if (id==='portfolio'){
        if (i===0 && (j>=7)) return; // ‚ùå –°–≤–æ–±–æ–¥–Ω—ã–µ, –û–±—â–∞—è, –û–±–Ω–æ–≤–ª–µ–Ω–æ
        if (i>0 && (j>=7)) return;
      }
      const tag = i===0 ? "th" : "td";
      const td  = document.createElement(tag);
      let val   = String(cell).trim();

      if (id==='orders' && i>0 && j===3) td.className = val==="BUY"?"buy":val==="SELL"?"sell":"";
      if (id==='portfolio' && i>0 && (j===5 || j===6)) td.className = clsPnL(val);

      td.textContent = val;
      tr.appendChild(td);
    });
    table.appendChild(tr);
  });
}

async function loadData(){
  try{
    document.getElementById('status').textContent="–û–±–Ω–æ–≤–ª—è—é‚Ä¶";
    const res = await fetch(API_URL);
    const data = await res.json();

    renderTable("portfolio", data.portfolio);
    renderTable("orders", data.openOrders);

    document.getElementById('ooCount').textContent= (data.openOrders?.length||1)-1;

    // –≤—ã—Ç–∞—â–∏–º USDT/—Å—É–º–º—É –∏–∑ –ø–µ—Ä–≤—ã—Ö —Å—Ç—Ä–æ–∫ –ø–æ—Ä—Ç—Ñ–µ–ª—è
    try{
      const scan = data.portfolio.slice(0,3);
      for (const r of scan){
        for (let i=0;i<r.length-1;i++){
          const k = String(r[i]||'').toLowerCase();
          if (k.includes('usdt')) document.getElementById('pfFree').textContent="USDT: "+r[i+1];
          if (k.includes('–æ–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å')) document.getElementById('pfTotal').textContent="Œ£: "+r[i+1];
        }
      }
    }catch(_){}

    document.getElementById('updated').textContent=new Date().toLocaleString();
    document.getElementById('status').textContent="–û–Ω–ª–∞–π–Ω";
  }catch(e){
    document.getElementById('status').textContent="–û—à–∏–±–∫–∞";
  }
}

loadData();
setInterval(loadData, 60000);
</script>
</body>
</html>
