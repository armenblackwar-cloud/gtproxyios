<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>GT ¬∑ Dashboard</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="GT Dashboard">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#171a21" />
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png">
  <style>
    :root{
      --bg:#0f0f12; --card:#171a21; --muted:#8a8f98; --text:#e9edf1;
      --green:#00c087; --red:#f6465d; --border:#2a2f3a; --yellow:#f0b90b;
    }
    html,body{height:100%;}
    body{margin:0; font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial;
      background:var(--bg); color:var(--text); min-height:100vh; padding-bottom:env(safe-area-inset-bottom);}
    header{position:sticky; top:0; background:#1a1f28; padding:8px 10px 2px 10px; font-size:12px; display:flex; flex-direction:column; gap:4px; z-index:2;}
    h1{font-size:17px; margin:0; color:var(--yellow);}
    .pill{padding:4px 10px; border-radius:18px; font-size:13px; font-weight:600; text-align:center; display:inline-block; min-width:80px; margin-bottom:2px;}
    .pill.online{background:#193e2d; color:var(--green);}
    .pill.offline{background:#3e1919; color:var(--red);}
    .pill.pos{background:#193e2d; color:var(--green);}
    .pill.neg{background:#3e1919; color:var(--red);}
    .pill.muted{background:#333; color:var(--muted);}
    .logout{background:#333; cursor:pointer; padding:8px 14px; margin:8px 4px; display:inline-block; border-radius:10px; font-size:14px;}
    .header-top{display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:space-between;}
    .header-pills-row{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:2px;}
    .header-pills-row:last-child{margin-bottom:0;}
    main{padding:8px 2px; display:grid; gap:9px}
    .card{background:var(--card); border:1px solid var(--border); border-radius:10px; overflow:hidden}
    .card h2{margin:0; padding:9px 8px; font-size:15px; border-bottom:1px solid var(--border); color:var(--yellow); display:flex; align-items:center; gap:8px;}
    .grid{overflow-x:auto}
    table{width:100%; border-collapse:collapse; font-size:10px; table-layout:auto;}
    th,td{padding:5px 2px;border:1px solid var(--border);text-align:center;white-space:normal;word-wrap:break-word;max-width:100px;}
    th{background:#1a1f28; color:#c8ccd3; font-size:11px; position:sticky; top:0}
    .buy{color:var(--green); font-weight:600}
    .sell{color:var(--red); font-weight:600}
    .pos{color:var(--green); font-weight:600}
    .neg{color:var(--red); font-weight:600}
    .muted{color:var(--muted)}
    .sectionRow{text-align:center; font-weight:700; color:var(--yellow); background:#222; padding:4px;}
    footer{padding:10px; font-size:11px; color:var(--muted); text-align:center}
    #startScreen{display:flex; flex-direction:column; justify-content:center; align-items:center; min-height:100vh; gap:24px; background:var(--bg);}
    .startBtn{background:var(--yellow); color:#000; font-weight:700; border:none; border-radius:12px; padding:17px 27px; font-size:18px; cursor:pointer; box-shadow:0 2px 8px #0001;}
    .btnRow{text-align:center; margin:12px 0;}
    .logo-icon{width:19px; height:19px; vertical-align:middle; margin-right:6px;}
    @media (max-width:700px){
      .header-top{flex-direction:column;align-items:flex-start;}
      .header-pills-row{gap:6px;}
      .card h2{font-size:16px;}
      th,td{font-size:11px;}
      main{padding:6px 2px;}
    }
    @media (max-width:450px){
      .pill{font-size:12px;padding:3px 8px;}
      .card h2{font-size:14px;padding:7px;}
      th,td{font-size:9px;padding:3px 1px;}
      .startBtn{font-size:15px;padding:11px 12px;}
    }
  </style>
</head>
<body>

<div id="startScreen">
  <h1><img src="icons/icon-192.png" alt="GT" class="logo-icon" /> GT</h1>
  <button class="startBtn" onclick="chooseMode('kripto')">GT-CRYPTO</button>
  <button class="startBtn" onclick="chooseMode('invest')">GT-INVEST</button>
</div>

<div id="app" style="display:none">
  <header>
    <div class="header-top">
      <h1 id="modePill"><img src="icons/icon-192.png" alt="GT" class="logo-icon" /> ‚Äî</h1>
      <span id="status" class="pill">‚Äî</span>
      <span id="updated" class="pill muted">‚Äî</span>
      <button id="switchBtn" class="pill">üîÑ –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å</button>
    </div>
    <div class="header-pills-row">
      <span id="pfFree" class="pill muted">–°–≤–æ–±–æ–¥–Ω—ã–µ: ‚Äî</span>
      <span id="pfTotal" class="pill muted">–û–±—ä–µ–º: ‚Äî</span>
    </div>
    <div class="header-pills-row">
      <span id="pfPnlPct" class="pill muted">PNL %: ‚Äî</span>
      <span id="pfPnlRub" class="pill muted">PNL ‚ÇΩ/$: ‚Äî</span>
    </div>
  </header>

  <main>
    <section class="card">
      <h2>üìà –ü–æ—Ä—Ç—Ñ–µ–ª—å</h2>
      <div class="grid"><table id="portfolio"></table></div>
    </section>
    <section class="card">
      <h2>üìë –û—Ç–∫—Ä—ã—Ç—ã–µ –æ—Ä–¥–µ—Ä–∞ (<b id="ooCount">‚Äî</b>)</h2>
      <div class="grid"><table id="orders"></table></div>
    </section>
  </main>

  <footer>
    üì± –ù–∞ iPhone: –ü–æ–¥–µ–ª–∏—Ç—å—Å—è ‚Üí ¬´–ù–∞ —ç–∫—Ä–∞–Ω –î–æ–º–æ–π¬ª<br>
    <span style="font-size:90%">–≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç offline (PWA)</span>
  </footer>

  <div class="btnRow">
    <button id="logoutBtn" class="logout">üö™ –í—ã–π—Ç–∏</button>
    <button id="copyBtn" class="logout">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
  </div>
</div>

<script>
// ====== –ü–∞—Ä–æ–ª—å ======
const PASSWORD = "Gt4815162342!";
const STORAGE_KEY = "gtbot_auth";
if (location.search.includes("logout=1")) {
  localStorage.removeItem(STORAGE_KEY);
  localStorage.removeItem("gtbot_mode");
  location.replace(location.origin + location.pathname);
}
function isAuthed(){ return localStorage.getItem(STORAGE_KEY) === "ok"; }
function ensureAuth() {
  if (isAuthed()) return true;
  const input = prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞:");
  if (input === PASSWORD) {
    localStorage.setItem(STORAGE_KEY, "ok");
    return true;
  }
  alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
  return false;
}

// ====== API ======
const API_URLS = {
  kripto: "https://script.google.com/macros/s/AKfycbxfMjbnI3FJXB5A29d0okRRelF4-I-4tEBddCWAbWUPJhSJRAEvpbC8DFOsv4Bxbs_m9A/exec",
  invest: "https://script.google.com/macros/s/AKfycbwTsu4LskXHYxx7x9QpA9u-eACTZsPWvjrvDF72nE0oScpAA7lf5a39ZDZWRTC2V8APpw/exec"
};
let currentMode = localStorage.getItem("gtbot_mode") || null;

function chooseMode(mode){
  if (!ensureAuth()) return;
  currentMode = mode;
  localStorage.setItem("gtbot_mode", mode);
  document.getElementById("startScreen").style.display="none";
  document.getElementById("app").style.display="block";
  updateModePill();
  loadData();
}

function updateModePill(){
  document.getElementById("modePill").innerHTML =
    `<img src="icons/icon-192.png" alt="GT" class="logo-icon" />` +
    (currentMode==="kripto" ? "GT-CRYPTO" : "GT-INVEST");
}

// ===== Helpers =====
function clsPnL(v){
  const s = String(v).replace(/\s/g,'');
  if (s === "" || s === "0" || s === "0,00" || s === "0.00" || s === "0%") return 'muted';
  if (parseFloat(s.replace(',','.')) < 0) return 'neg';
  return 'pos';
}
function fmtRub(val) {
  const num = parseFloat(val);
  if (isNaN(num)) return val;
  return num.toLocaleString('ru-RU', {minimumFractionDigits:2, maximumFractionDigits:2});
}
function fmtNum(val) {
  const num = parseFloat(val);
  if (isNaN(num)) return val;
  return num.toLocaleString('ru-RU', {minimumFractionDigits:2, maximumFractionDigits:2});
}
function fmtInvestPct(val) {
  const num = parseFloat(val) * 100;
  if (isNaN(num)) return val;
  return num.toLocaleString('ru-RU', {minimumFractionDigits:2, maximumFractionDigits:2}) + "%";
}
function fmtRuDate(str) {
  try {
    const dt = new Date(str);
    if (isNaN(dt.getTime())) return str;
    dt.setHours(dt.getHours() + 3);
    return dt.toLocaleString('ru-RU', {
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit', second: '2-digit'
    }).replace(',', '');
  } catch(e) { return str; }
}
function fmtCryptoPnl(val, symbol) {
  if (!val || val === "" || val === "‚Äî" || isNaN(parseFloat(val))) return "‚Äî";
  let str = String(val).replace('.', ',');
  return str + symbol;
}
function setPillWithLabel(id, label, value, formatted, symbol = '') {
  const el = document.getElementById(id);
  const cls = clsPnL(value);
  el.className = `pill ${cls}`;
  el.textContent = `${label} ${formatted}`;
}

// ===== Render =====
function renderTable(id, rows){
  const table = document.getElementById(id);
  table.innerHTML = "";
  if (!rows || !rows.length){
    table.innerHTML = "<tr><td class='muted'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>";
    return;
  }
  rows.forEach((row,i)=>{
    let filteredRow = row;
    if (id==='orders'){ 
      filteredRow = [row[2], row[3], row[4], row[6], row[7], row[8]]; 
    }
    if (id==='portfolio'){ 
      filteredRow = [row[0], row[1], row[2], row[3], row[4], row[5], row[6], row[7]];
    }
    const firstCell = String(filteredRow[0]||"").toLowerCase();
    const isSection = firstCell.includes("–∞–∫—Ü–∏–∏") || firstCell.includes("—Ñ–æ–Ω–¥—ã") || firstCell.includes("–≤–∞–ª—é—Ç") || firstCell.includes("–º–µ—Ç–∞–ª–ª");
    const tr = document.createElement("tr");
    if(isSection){
      const td = document.createElement("td");
      td.colSpan = filteredRow.length;
      td.textContent = row[0];
      td.className = "sectionRow";
      tr.appendChild(td);
    } else {
      filteredRow.forEach((cell,j)=>{
        const tag = i===0?"th":"td";
        const td=document.createElement(tag);
        let val = (cell===undefined || cell===null) ? "" : String(cell).trim();
        if (id==='orders' && i>0 && j===1){ td.className=val==="BUY"?"buy":val==="SELL"?"sell":""; }
        if (id==='portfolio' && i>0 && (j === 6 || j === 7)) td.className=clsPnL(val);
        // INVEST ‚Äî –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è!
        if (currentMode === "invest" && id === 'portfolio' && i > 0) {
          if (j >= 2 && j <= 5) val = fmtNum(val);
          if (j === 6) val = fmtRub(val);
          if (j === 7) val = fmtInvestPct(val);
        }
        // CRYPTO ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º % –∫ PnL %
        if (currentMode === "kripto" && id === 'portfolio' && i > 0 && j === 6) {
          if (val !== "") val = val + "%";
        }
        td.textContent = val;
        tr.appendChild(td);
      });
    }
    table.appendChild(tr);
  });
}

// ===== Load =====
function findValueByTitle(portfolio, title) {
  for (let i = 0; i < portfolio.length; i++) {
    if (String(portfolio[i][9]).includes(title)) {
      return portfolio[i + 1]?.[9] ?? "‚Äî";
    }
  }
  return "‚Äî";
}

async function loadData(){
  if (!currentMode) return;
  try{
    document.getElementById('status').textContent="–û–±–Ω–æ–≤–ª—è—é‚Ä¶";
    document.getElementById('status').className="pill";
    const res = await fetch(API_URLS[currentMode]);
    const data = await res.json();
    renderTable("portfolio", data.portfolio);
    renderTable("orders", data.openOrders);
    document.getElementById('ooCount').textContent=(data.openOrders?.length||1)-1;
    let free="‚Äî", total="‚Äî", pnlVal="‚Äî", pnlPct="‚Äî", updated="‚Äî";
    if(currentMode === "invest"){
      free    = findValueByTitle(data.portfolio, "–°–≤–æ–±–æ–¥–Ω—ã–µ ‚ÇΩ");
      total   = findValueByTitle(data.portfolio, "–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ—Ä—Ç—Ñ–µ–ª—è");
      pnlVal  = findValueByTitle(data.portfolio, "PNL ‚ÇΩ");
      pnlPct  = findValueByTitle(data.portfolio, "PNL %");
      updated = findValueByTitle(data.portfolio, "–í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è");
      setPillWithLabel('pfFree',      '–°–≤–æ–±–æ–¥–Ω—ã–µ ‚ÇΩ:', free, fmtRub(free));
      setPillWithLabel('pfTotal',     '–û–±—ä–µ–º ‚ÇΩ:',     total, fmtRub(total));
      setPillWithLabel('pfPnlPct',    'PNL %:',       pnlPct, fmtInvestPct(pnlPct), '');
      setPillWithLabel('pfPnlRub',    'PNL ‚ÇΩ:',       pnlVal, fmtRub(pnlVal), '');
      document.getElementById('updated').textContent = fmtRuDate(updated);
      document.getElementById('updated').className = "pill muted";
    } else if(currentMode === "kripto"){
      free    = findValueByTitle(data.portfolio, "–°–≤–æ–±–æ–¥–Ω—ã–µ $");
      total   = findValueByTitle(data.portfolio, "–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ—Ä—Ç—Ñ–µ–ª—è");
      pnlPct  = findValueByTitle(data.portfolio, "–û–±—â–∏–π PnL %");
      pnlVal  = findValueByTitle(data.portfolio, "–û–±—â–∏–π PnL $");
      updated = findValueByTitle(data.portfolio, "–í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è");
      setPillWithLabel('pfFree',      '–°–≤–æ–±–æ–¥–Ω—ã–µ $:', free, fmtCryptoPnl(free, ''));
      setPillWithLabel('pfTotal',     '–û–±—ä–µ–º $:',     total, fmtCryptoPnl(total, ''));
      setPillWithLabel('pfPnlPct',    'PNL %:',       pnlPct, fmtCryptoPnl(pnlPct, '%'));
      setPillWithLabel('pfPnlRub',    'PNL $:',       pnlVal, fmtCryptoPnl(pnlVal, ''));
      document.getElementById('updated').textContent = fmtRuDate(updated);
      document.getElementById('updated').className = "pill muted";
    }
    document.getElementById('status').textContent="–û–Ω–ª–∞–π–Ω";
    document.getElementById('status').className="pill online";
  }catch(e){
    document.getElementById('status').textContent="–û—Ñ—Ñ–ª–∞–π–Ω";
    document.getElementById('status').className="pill offline";
  }
}

// Auto-refresh
setInterval(loadData,60000);
document.getElementById("switchBtn").onclick=()=>{ chooseMode(currentMode==="kripto"?"invest":"kripto"); };
document.getElementById('logoutBtn').onclick=()=>{ 
  localStorage.removeItem(STORAGE_KEY); 
  localStorage.removeItem("gtbot_mode"); 
  location.reload(); 
};
document.getElementById('copyBtn').onclick = () => {
  function tableToText(id, title){
    const rows = [...document.getElementById(id).rows];
    if (!rows.length) return `${title}: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö\n`;
    let text = `\n### ${title}\n`;
    text += rows.map(r => [...r.cells].map(c => c.innerText).join(" | ")).join("\n");
    return text;
  }
  let out = "üìä –î–∞–Ω–Ω—ã–µ GT-BOT\n";
  out += tableToText("portfolio", "–ü–æ—Ä—Ç—Ñ–µ–ª—å");
  out += "\n";
  out += tableToText("orders", "–û—Ç–∫—Ä—ã—Ç—ã–µ –æ—Ä–¥–µ—Ä–∞");
  navigator.clipboard.writeText(out).then(()=>alert("‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ")).catch(()=>alert("‚ö† –û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è"));
};
if (currentMode){ 
  document.getElementById("startScreen").style.display="none"; 
  document.getElementById("app").style.display="block"; 
  updateModePill(); 
  loadData(); 
}
// PWA install
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js');
  });
}
</script>
</body>
</html>
