<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>GT-–ë–æ—Ç ¬∑ –î–∞—à–±–æ—Ä–¥</title>

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="GT-–ë–æ—Ç">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <style>
    :root{
      --bg:#0f0f12; --card:#171a21; --muted:#8a8f98; --text:#e9edf1;
      --green:#00c087; --red:#f6465d; --border:#2a2f3a; --yellow:#f0b90b;
    }
    body{
      margin:0; font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial;
      background:var(--bg); color:var(--text);
    }
    header{position:sticky; top:0; background:#1a1f28; padding:6px; font-size:11px}
    .wrap{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    h1{font-size:14px; margin:0; color:var(--yellow);}
    .pill{
      padding:1px 6px; border-radius:10px; font-size:10px; 
      font-weight:600; min-width:55px; text-align:center;
    }
    .pill.online{background:#193e2d; color:var(--green);}
    .pill.offline{background:#3e1919; color:var(--red);}
    main{padding:6px; display:grid; gap:8px}
    .card{background:var(--card); border:1px solid var(--border); border-radius:8px; overflow:hidden}
    .card h2{margin:0; padding:6px; font-size:12px; border-bottom:1px solid var(--border); color:var(--yellow)}
    .grid{overflow-x:hidden}
    table{width:100%; border-collapse:collapse; font-size:7.5px; table-layout:fixed}
    th,td{padding:3px 2px; border-bottom:1px solid var(--border); text-align:center; white-space:nowrap}
    th{background:#1a1f28; color:#c8ccd3; font-size:8px; position:sticky; top:0}
    .buy{color:var(--green); font-weight:600}
    .sell{color:var(--red); font-weight:600}
    .pos{color:var(--green); font-weight:600}
    .neg{color:var(--red); font-weight:600}
    .muted{color:var(--muted)}
    footer{padding:4px; font-size:9px; color:var(--muted); text-align:center}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>GT-–ë–æ—Ç</h1>
      <span id="status" class="pill">‚Äî</span>
      <span id="pfFree" class="pill">USDT: ‚Äî</span>
      <span id="pfTotal" class="pill">‚àë: ‚Äî</span>
      <span id="updated" class="pill">‚Äî</span>
    </div>
  </header>

  <main>
    <section class="card">
      <h2>üìä –ü–æ—Ä—Ç—Ñ–µ–ª—å</h2>
      <div class="grid"><table id="portfolio"></table></div>
    </section>

    <section class="card">
      <h2>üìë –û—Ç–∫—Ä—ã—Ç—ã–µ –æ—Ä–¥–µ—Ä–∞ (<b id="ooCount">‚Äî</b>)</h2>
      <div class="grid"><table id="orders"></table></div>
    </section>
  </main>

  <footer>üì± –î–æ–±–∞–≤—å –Ω–∞ iPhone: –ü–æ–¥–µ–ª–∏—Ç—å—Å—è ‚Üí ¬´–ù–∞ —ç–∫—Ä–∞–Ω –î–æ–º–æ–π¬ª</footer>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxfMjbnI3FJXB5A29d0okRRelF4-I-4tEBddCWAbWUPJhSJRAEvpbC8DFOsv4Bxbs_m9A/exec";

function clsPnL(v){
  const x = parseFloat(v);
  if (isNaN(x) || x===0) return 'muted';
  return x>0 ? 'pos' : 'neg';
}

function renderTable(id, rows){
  const table = document.getElementById(id);
  table.innerHTML = "";
  if (!rows || !rows.length){
    table.innerHTML = "<tr><td class='muted'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>";
    return;
  }

  rows.forEach((row, i)=>{
    // ‚ö° —Ñ–∏–ª—å—Ç—Ä—É–µ–º –Ω–µ–Ω—É–∂–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏
    let filteredRow = row;

    if (id === 'orders'){
      // —É–±–∏—Ä–∞–µ–º: –í—Ä–µ–º—è (0), –ö–∞—Ç–µ–≥–æ—Ä–∏—è (1), –°—Ç–∞—Ç—É—Å (5)
      filteredRow = row.filter((_, j)=> ![0,1,5].includes(j));
    }

    if (id === 'portfolio'){
      if (i === 0){
        // —É–±–∏—Ä–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏: –°–≤–æ–±–æ–¥–Ω—ã–µ, –û–±—â–∞—è, –û–±–Ω–æ–≤–ª–µ–Ω–æ
        filteredRow = row.filter(h =>
          !(String(h).includes("–°–≤–æ–±–æ–¥") || String(h).includes("–û–±—â–∞—è") || String(h).includes("–û–±–Ω–æ–≤"))
        );
      } else {
        // —É–±–∏—Ä–∞–µ–º —Å–∞–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è —ç—Ç–∏—Ö –∫–æ–ª–æ–Ω–æ–∫ (—Ñ–∏–∫—Å –ø–æ –∏–Ω–¥–µ–∫—Å–∞–º)
        filteredRow = row.slice(0,7); // –ø–µ—Ä–≤—ã–µ 7 –∫–æ–ª–æ–Ω–æ–∫ (—Ç–∏–∫–µ—Ä ‚Üí PnL $)
      }
    }

    const tr = document.createElement("tr");
    filteredRow.forEach((cell, j)=>{
      const tag = i===0 ? "th" : "td";
      const td  = document.createElement(tag);
      const val = String(cell).trim();

      if (id==='orders' && i>0 && filteredRow[2]==="BUY") td.className="buy";
      if (id==='orders' && i>0 && filteredRow[2]==="SELL") td.className="sell";
      if (id==='portfolio' && i>0 && (j===5 || j===6)) td.className = clsPnL(val);

      td.textContent = val;
      tr.appendChild(td);
    });
    table.appendChild(tr);
¬†¬†});
}

async function loadData(){
  try{
    document.getElementById('status').textContent="–û–±–Ω–æ–≤–ª—è—é‚Ä¶";
    document.getElementById('status').className="pill";
    const res = await fetch(API_URL);
    const data = await res.json();
    renderTable("portfolio", data.portfolio);
    renderTable("orders", data.openOrders);
    document.getElementById('ooCount').textContent= (data.openOrders?.length||1)-1;

    // –¥–æ—Å—Ç–∞–µ–º —Å–≤–æ–¥–∫—É
    let free = "‚Äî", total="‚Äî";
    try{
      const scan = data.portfolio.slice(0,3);
      for (const r of scan){
        for (let i=0;i<r.length-1;i++){
          const k = String(r[i]||'').toLowerCase();
          if (k.includes('—Å–≤–æ–±–æ–¥–Ω—ã–µ usdt')) free = r[i+1];
          if (k.includes('–æ–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ—Ä—Ç—Ñ–µ–ª—è')) total = r[i+1];
        }
      }
    }catch(_){}
    document.getElementById('pfFree').textContent = "USDT: "+free;
    document.getElementById('pfTotal').textContent = "‚àë: "+total;

    document.getElementById('updated').textContent = new Date().toLocaleString('ru-RU');
    document.getElementById('status').textContent="–û–Ω–ª–∞–π–Ω";
    document.getElementById('status').className="pill online";
  }catch(e){
    document.getElementById('status').textContent="–û—Ñ—Ñ–ª–∞–π–Ω";
    document.getElementById('status').className="pill offline";
  }
}

loadData();
setInterval(loadData, 60000);
</script>
</body>
</html>
