<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>GT-–ë–æ—Ç ¬∑ –î–∞—à–±–æ—Ä–¥</title>

  <!-- iOS: –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º –∏ —Å—Ç–∞—Ç—É—Å-–±–∞—Ä -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="GT-–ë–æ—Ç">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#111111" />

<style>
  :root{
    --bg:#0f1115; --card:#171a21; --muted:#8a8f98; --text:#e9edf1; 
    --green:#1ec28b; --red:#ff6b6b; --border:#2a2f3a; --accent:#4f86ff;
  }
  body{ margin:0; font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial;
        background:var(--bg); color:var(--text); }
  table{ width:100%; border-collapse:collapse; font-size:13px; min-width:600px }
  th,td{ padding:8px; border-bottom:1px solid var(--border); text-align:right; }
  th:first-child, td:first-child{text-align:left}
  .buy { color: var(--green); font-weight:600; }
  .sell{ color: var(--red);   font-weight:600; }
  .pos { color: var(--green); }
  .neg { color: var(--red); }
  .muted { color: var(--muted); }
  /* üì± –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ */
  .grid { overflow-x:auto; -webkit-overflow-scrolling:touch; }
</style>

</head>
<body>
  <header>
    <div class="wrap row">
      <h1>GT-–ë–æ—Ç ¬∑ –î–∞—à–±–æ—Ä–¥</h1>
      <span id="status" class="pill">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</span>
      <span id="updated" class="pill">–û–±–Ω–æ–≤–ª–µ–Ω–æ ‚Äî ‚Ä¶</span>
      <button id="btnReload" class="secondary">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>
  </header>

  <main>
    <section class="card" id="portfolioCard">
      <h2>üìä –ü–æ—Ä—Ç—Ñ–µ–ª—å</h2>
      <div class="meta">
        <span>–í—Å–µ–≥–æ –ø–æ–∑–∏—Ü–∏–π: <b id="pfCount">‚Äî</b></span>
        <span>–°–≤–æ–±–æ–¥–Ω—ã–µ USDT: <b id="pfFree">‚Äî</b></span>
        <span>–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ—Ä—Ç—Ñ–µ–ª—è: <b id="pfTotal">‚Äî</b></span>
      </div>
      <div class="grid">
        <table id="portfolio"></table>
      </div>
    </section>

    <section class="card" id="ordersCard">
      <h2>üìë –û—Ç–∫—Ä—ã—Ç—ã–µ –æ—Ä–¥–µ—Ä–∞</h2>
      <div class="meta">
        <span>–ê–∫—Ç–∏–≤–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤: <b id="ooCount">‚Äî</b></span>
      </div>
      <div class="grid">
        <table id="orders"></table>
      </div>
    </section>
  </main>

  <div class="footer">
    <div class="wrap">
      <div class="hint">–î–æ–±–∞–≤—å –Ω–∞ –∞–π—Ñ–æ–Ω: <b>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è ‚Üí –ù–∞ —ç–∫—Ä–∞–Ω ¬´–î–æ–º–æ–π¬ª</b> (–±—É–¥–µ—Ç –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)</div>
      <div class="row">
        <button id="btnInstall" class="secondary">‚ûï –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
        <button id="btnAuto" class="">‚è± –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –≤—ã–∫–ª</button>
      </div>
    </div>
  </div>

<script>
/** ====== –ù–ê–°–¢–†–û–ô–ö–ê API ======
 * –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ—é —Å—Å—ã–ª–∫—É Apps Script (JSON: { portfolio, openOrders }).
 * –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —á–µ—Ä–µ–∑ ?api=... –≤ URL.
 */
const DEFAULT_API = "https://script.google.com/macros/s/AKfycbxfMjbnI3FJXB5A29d0okRRelF4-I-4tEBddCWAbWUPJhSJRAEvpbC8DFOsv4Bxbs_m9A/exec";
const params = new URLSearchParams(location.search);
const API_URL = params.get("api") || DEFAULT_API;

const elStatus  = document.getElementById('status');
const elUpdated = document.getElementById('updated');
const elPfCount = document.getElementById('pfCount');
const elPfFree  = document.getElementById('pfFree');
const elPfTotal = document.getElementById('pfTotal');
const elOoCount = document.getElementById('ooCount');
const btnReload = document.getElementById('btnReload');
const btnInstall= document.getElementById('btnInstall');
const btnAuto   = document.getElementById('btnAuto');

let autoTimer = null;
let deferredPrompt = null; // –¥–ª—è Android/desktop; –Ω–∞ iOS ‚Äî —Ä—É—á–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞

function fmtNum(n, digits=2){
  if (n === "" || n === null || n === undefined || isNaN(Number(n))) return "‚Äî";
  return Number(n).toLocaleString('ru-RU', { maximumFractionDigits: digits });
}
function clsPnL(v){
  const x = Number(String(v).replace('%',''));
  if (!isFinite(x) || x===0) return 'muted';
  return x>0 ? 'pos' : 'neg';
}
function renderTable(id, rows){
  const table = document.getElementById(id);
  table.innerHTML = "";
  if (!rows || !rows.length){
    table.innerHTML = "<tr><td class='muted'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>";
    return;
  }
  rows.forEach((row, i) => {
    const tr = document.createElement("tr");
    row.forEach((cell, j) => {
      const tag = i===0 ? "th" : "td";
      const td = document.createElement(tag);
      let val = cell;

      // –ª—ë–≥–∫–∞—è –∫–æ—Å–º–µ—Ç–∏–∫–∞ –¥–ª—è –ø–æ—Ä—Ç—Ñ–µ–ª—è: PnL%/PnL$ –ø–æ–¥—Å–≤–µ—Ç–∏–º
      if (id === 'portfolio' && i>0 && (j===5 || j===6)) {
        td.className = clsPnL(val);
      }
      td.textContent = val;
      tr.appendChild(td);
    });
    table.appendChild(tr);
  });
}

/** –ò–∑ –ø–æ—Ä—Ç—Ñ–µ–ª—è ‚Äî –≤—ã—Ç–∞—â–∏–º —Å–≤–æ–¥–∫–∏ –∏–∑ —à–∞–ø–∫–∏ (—Ç–∞–º —É —Ç–µ–±—è I1/J1 –∏ K1/L1, –Ω–æ –≤ API –º—ã —á–∏—Ç–∞–µ–º –≤–µ—Å—å range displayValues).
 * –ï—Å–ª–∏ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–æ–π –∏–¥—É—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∏, –ø–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ ¬´–°–≤–æ–±–æ–¥–Ω—ã–µ USDT¬ª –∏ ¬´–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å‚Ä¶¬ª –≤ –ø–µ—Ä–≤—ã—Ö 2 —Å—Ç—Ä–æ–∫–∞—Ö.
 * –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥—ë–º ‚Äî –æ—Å—Ç–∞–≤–∏–º –ø—Ä–æ—á–µ—Ä–∫.
 */
function extractPortfolioSummary(portfolioRows){
  try{
    // –±—ã—Å—Ç—Ä—ã–π –ø—É—Ç—å: –µ—Å–ª–∏ –≤ —Ç–∞–±–ª–∏—á–Ω–æ–π —á–∞—Å—Ç–∏ –µ—Å—Ç—å ¬´–°–≤–æ–±–æ–¥–Ω—ã–µ USDT¬ª/¬´–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å‚Ä¶¬ª –≤ –ø–µ—Ä–≤—ã—Ö 3 —Å—Ç—Ä–æ–∫–∞—Ö
    let free = null, total = null;
    const scan = portfolioRows.slice(0,3);
    for (const r of scan){
      for (let i=0;i<r.length-1;i++){
        const k = String(r[i]||'').toLowerCase();
        if (k.includes('—Å–≤–æ–±–æ–¥–Ω—ã–µ usdt')) free = r[i+1];
        if (k.includes('–æ–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ—Ä—Ç—Ñ–µ–ª—è')) total = r[i+1];
      }
    }
    return { free, total };
  }catch(_){ return { free:null, total:null }; }
}

async function loadData() {
  const t0 = performance.now();
  elStatus.textContent = "–û–±–Ω–æ–≤–ª—è—é‚Ä¶";
  try {
    const ctrl = new AbortController();
    const timeout = setTimeout(()=>ctrl.abort(), 15000); // 15—Å —Ç–∞–π–º–∞—É—Ç
    const res = await fetch(API_URL, { signal: ctrl.signal, cache: "no-store" });
    clearTimeout(timeout);

    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();

    // –†–µ–Ω–¥–µ—Ä —Ç–∞–±–ª–∏—Ü (–≤ API –∫–ª—é—á–∏: portfolio, openOrders)
    const portfolio = Array.isArray(data.portfolio) ? data.portfolio : [];
    const orders    = Array.isArray(data.openOrders) ? data.openOrders : [];

    renderTable("portfolio", portfolio);
    renderTable("orders", orders);

    // –°–≤–æ–¥–∫–∏
    elPfCount.textContent = Math.max(0, portfolio.length - 1);
    elOoCount.textContent = Math.max(0, orders.length - 1);

    const { free, total } = extractPortfolioSummary(portfolio);
    elPfFree.textContent  = free  != null ? free  : "‚Äî";
    elPfTotal.textContent = total != null ? total : "‚Äî";

    // –ú–µ—Ç–∫–∏
    const dt = new Date();
    elUpdated.textContent = "–û–±–Ω–æ–≤–ª–µ–Ω–æ ‚Äî " + dt.toLocaleString('ru-RU');
    elStatus.textContent  = "–û–Ω–ª–∞–π–Ω";
    // —Å–æ—Ö—Ä–∞–Ω–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —É–¥–∞—á–Ω—ã–π —Å–Ω–∞–ø—à–æ—Ç ‚Äî SW —Ç–æ–∂–µ –º–æ–∂–µ—Ç –∫–µ—à–∏—Ä–æ–≤–∞—Ç—å, –Ω–æ –ø—Ä–æ–¥—É–±–ª–∏—Ä—É–µ–º
    localStorage.setItem("lastData", JSON.stringify({ data, ts: Date.now() }));
  } catch (err) {
    elStatus.textContent = "–û—Ñ—Ñ–ª–∞–π–Ω";
    // –ø–æ–ø—Ä–æ–±—É–µ–º –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–Ω–∞–ø—à–æ—Ç–∞
    const snap = localStorage.getItem("lastData");
    if (snap){
      try{
        const { data } = JSON.parse(snap);
        renderTable("portfolio", data.portfolio || []);
        renderTable("orders", data.openOrders || []);
      }catch(_){}
    }
  } finally {
    const ms = Math.round(performance.now() - t0);
    console.log("loadData done in", ms, "ms");
  }
}

btnReload.onclick = () => loadData();

btnAuto.onclick = () => {
  if (autoTimer){
    clearInterval(autoTimer);
    autoTimer = null;
    btnAuto.textContent = "‚è± –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –≤—ã–∫–ª";
  } else {
    autoTimer = setInterval(loadData, 30000); // –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫
    btnAuto.textContent = "‚è± –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –≤–∫–ª (30—Å)";
  }
};

// PWA —É—Å—Ç–∞–Ω–æ–≤–∫–∞ (Android/desktop). –ù–∞ iOS ‚Äî –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ ¬´–ù–∞ —ç–∫—Ä–∞–Ω –î–æ–º–æ–π¬ª.
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
});
btnInstall.onclick = async () => {
  if (deferredPrompt){
    deferredPrompt.prompt();
    deferredPrompt = null;
  } else {
    alert("–ù–∞ iPhone: –ü–æ–¥–µ–ª–∏—Ç—å—Å—è ‚Üí –ù–∞ —ç–∫—Ä–∞–Ω ¬´–î–æ–º–æ–π¬ª.\n–ù–∞ Android/–¥–µ—Å–∫—Ç–æ–ø–µ –∫–Ω–æ–ø–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è, –∫–æ–≥–¥–∞ –±—Ä–∞—É–∑–µ—Ä –ø—Ä–µ–¥–ª–æ–∂–∏—Ç —É—Å—Ç–∞–Ω–æ–≤–∫—É.");
  }
};

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è service worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').then(()=>console.log('SW ok')).catch(console.warn);
}

// –°—Ç–∞—Ä—Ç–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
loadData();
</script>
</body>
</html>
